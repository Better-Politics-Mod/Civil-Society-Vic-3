#==========TOOLING==========#
ciso_civsoc_process_tooling_handle_creation = {
	if = {
		limit = {
			$ci$_creation_trigger = yes
		}
		add_to_variable_list = {
			name = ciso_civil_institutions
			target = flag:$ci$
		}
	}
	else = {
		remove_list_variable = {
			name = ciso_civil_institutions
			target = flag:$ci$
		}
	} 
}

ciso_init_civsoc = {
	every_scope_state = {
		limit = {
			ciso_state_has_civil_society = yes
		}
		ciso_civsoc_process_monthly = yes
		ciso_needs_process_monthly = yes
		# do something
	}
}

ciso_need_process_tooling_handle_needs = {
	if = {
		limit = {
			$ne$_rfp >= $min$
		}
		add_to_variable_list = {
			name = ciso_needs
			target = flag:$ne$
		}
	}
	else = {
		remove_list_variable = {
			name = ciso_needs
			target = flag:$ne$
		}
	}
}


#### THE BULK ####

ciso_calculate_allocation = {
	save_scope_as = state
	

	# First we need to calculate Î»
	set_local_variable = { 
		name = avg_sqrt_w
		# TODO GEN
		value = ciso_$ci$_avg_sqrt_weight
	}

	set_local_variable = {
		name = avg_shift
		# TODO GEN
		value = ciso_avg_already_allocated
	}
	# lambda = (B * avg_sqrt_w / (M / n + avg_shift)) ** 2
	save_scope_value_as = {
		name = lambda
		value = {
			value = {
				value = ciso_B
				multiply = local_var:avg_sqrt_w
				divide = {
					value = {
						# TODO GEN
						value = ciso_$ci$_social_impact
						# TODO GEN
						divide = ciso_$ci$_num_measures
					}
					add = local_var:avg_shift
				}
			}
			multiply = {
				value = $B$
				multiply = local_var:avg_sqrt_w
				divide = {
					value = {
						# TODO GEN
						value = ciso_$ci$_social_impact
						# TODO GEN
						divide = ciso_$ci$_num_measures
					}
					add = local_var:avg_shift
				}
			}
		}
	}
	# TODO: GEN ciso_$ci$_weight
	ciso_do_every_measure_with_ci = { ci = $ci$ } #{
		# ci = $ci$
		# # scope = state
		# # $me$ = measure key
		# # scope:measure = flag:$me$

		# # TODO: Gen ciso_$ci$_me_weight
		# do = "
		# 	set_local_variable = {
		# 		name = ciso_raw_alloc
		# 		value = {
		# 			value = {
		# 				ciso_$ci$_me_weight
		# 				divide = local_var:lambda
		# 				round_to = 0.1
		# 				pow = 0.5
		# 			}
		# 			multiply = ciso_B
		# 			subtract = ciso_B
		# 			subtract = var:ciso_$me$_ci_investment_var
		# 		}
		# 	}
		# "
	#}
}