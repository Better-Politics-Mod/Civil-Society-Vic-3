#==========TOOLING==========#
ciso_civsoc_process_tooling_handle_creation = {
	if = {
		limit = {
			$ci$_creation_trigger = yes
		}
		add_to_variable_list = {
			name = ciso_civil_institutions
			target = flag:$ci$
		}
	}
	else = {
		remove_list_variable = {
			name = ciso_civil_institutions
			target = flag:$ci$
		}
	} 
}

ciso_init_civsoc = {
	every_scope_state = {
		limit = {
			ciso_state_has_civil_society = yes
		}
		ciso_civsoc_process_monthly = yes
		ciso_needs_process_monthly = yes
		ciso_needs_process_monthly = yes
		# do something
	}
}

ciso_need_process_tooling_handle_needs = {
	if = {
		limit = {
			$ne$_rfp >= $min$
		}
		add_to_variable_list = {
			name = ciso_needs
			target = flag:$ne$
		}
	}
	else = {
		remove_list_variable = {
			name = ciso_needs
			target = flag:$ne$
		}
	}
}



#### THE BULK ####

ciso_calculate_allocation = {
	save_scope_as = state
	
	if = {
		limit = {
			is_target_in_variable_list = {
				name = ciso_civil_institutions
				target = flag:$ci$
			}
		}
		# First we need to calculate Î»
		save_scope_value_as = { 
			name = avg_sqrt_w
			value = $ci$_avg_sqrt_weight
		}

		clear_saved_scope = measure

		save_scope_value_as = {
			name = avg_shift
			value = ciso_avg_already_allocated
		}

		clear_saved_scope = measure
		# lambda = (B * avg_sqrt_w / (M / n + avg_shift)) ** 2
		save_scope_value_as = {
			name = lambda
			value = {
				value = {
					value = ciso_B
					multiply = scope:avg_sqrt_w
					divide = {
						value = {
							value = $ci$_social_impact
							divide = $ci$_num_measures
						}
						add = scope:avg_shift
					}
				}
				multiply = {
					value = ciso_B
					multiply = scope:avg_sqrt_w
					divide = {
						value = {
							value = $ci$_social_impact
							divide = $ci$_num_measures
						}
						add = scope:avg_shift
					}
				}
			}
		}
		clear_saved_scope = measure

		ciso_do_every_measure_with_ci = { ci = $ci$ } 
	}
}


ciso_apply_ms_effect = {
	if = {
		limit = {
			has_modifier = $ms$_effect
		}
		remove_modifier = $ms$_effect
	}
	if = {
		limit = {
			$ms$_investment > 0
		}
		# calculate effect value
		set_local_variable = {
			name = effect_value
			# investment * ciso_B / (ciso_B + investment)
			# this means diminishing returns on investment
			value = {
				value = $ms$_investment
				multiply = ciso_B
				divide = {
					value = ciso_B
					add = $ms$_investment
				}
			}
		}
		add_modifier = {
			name = $ms$_effect
			multiplier = local_var:effect_value
		}
	}
}